<!--
 * Sourcerer: an infrastructure for large-scale source code analysis.
 * Copyright (C) by contributors. See CONTRIBUTORS.txt for full list.
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.

 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.

 * You should have received a copy of the GNU General Public License
 * along with this program. If not, see <http://www.gnu.org/licenses/>.
 -->
<!-- @author Joel Ossher (jossher@uci.edu) -->
<!-- @author Sushil Bajracharya (bajracharya@gmail.com) -->
<project name="Sourcerer Infrastructure" basedir=".">
  <description>
    Build file for the Sourcerer Infrastructure.
  </description>
  <!-- There should be a different build location for each target,
       so that the jars don't contain unneeded files -->
  <property name="build" location="build" />
  <property name="build-link-crawler" location="${build}/link-crawler" />
  <property name="build-utilization" location="${build}/utilization" />
  <property name="build-java-repo-tools" location="${build}/java-repo-tools" />
  <property name="build-extractor-lib" location="${build}/extractor-lib" />
  <property name="build-extractor" location="${build}/extractor" />
  <property name="build-database" location="${build}/database" />
  <property name="build-artifact-repo-browser" location="${build}/artifact-repo-browser" />
  <property name="build-file-server" location="${build}/file-server" />
  <property name="build-code-browser" location="${build}/code-browser" />
  <property name="build-comparison-test" location="${build}/comparison-test" />
  
  <property name="build-search-eval" location="${build}/search-eval" />
  <property name="build-search-server" location="${build}/search-server" />
  <property name="build-core-repomanager" location="${build}/core-repomanager" />
  <property name="build-codecrawler" location="${build}/codecrawler" />
  
  <property name="build-machine-learning" location="${build}/machine-learning" />

  <property name="dist" location="dist" />

  <!-- Utilities -->
  <property name="lib" location="../lib" />
  <property name="utilities" location="../infrastructure/utils/utilities/src" />
  <property name="database-utilities" location="../infrastructure/utils/database-utilities/src" />
  <property name="servlet-utilities" location="../infrastructure/utils/servlet-utilities/src" />
  
  <!-- Core Tools -->
  <property name="core-repository-manager" location="../infrastructure/tools/core/repository-manager/src" />
  <property name="link-crawler" location="../infrastructure/tools/core/link-crawler/src" />
  
  <!-- Java Tools -->
  <property name="java-repository-manager" location="../infrastructure/tools/java/repository-manager/src" />
  <property name="model" location="../infrastructure/tools/java/model/src" />
  <property name="extractor" location="../infrastructure/tools/java/extractor" />
  <property name="utilization" location="../infrastructure/tools/java/utilization/src" />
  <property name="database" location="../infrastructure/tools/java/database/src" />

  <!-- Test Repository -->
  <property name="test-repo" location="../infrastructure/tools/java/extractor/test-repo" />
  <property name="comparison-test" location="${test-repo}/0/2/content/src" />
    
	<property name="component-clusterer" location="../infrastructure/tools/java/component-clusterer/src" />
  
	<property name="syntax-highlighter" location="../infrastructure/tools/java/syntax-highlighter/src" />
  
  <!-- Servlets -->
  <property name="artifact-repo-browser" location="../infrastructure/apps/artifact-repo-browser/src" />
  
  <property name="search-eval" location="../infrastructure/apps/codesearch/src" />
  <property name="search-server" location="../infrastructure/services/search-server/src" />
  <property name="solr-root" location="../infrastructure/services/solr-1.3-patched" />
  <property name="codecrawler" location="../infrastructure/tools/core/codecrawler/src" />
  <property name="file-server" location="../infrastructure/services/file-server/src" />
	<property name="famix-server" location="../infrastructure/services/famix-server/src" />
	<property name="code-browser" location="../infrastructure/apps/code-browser/src" />
  <property name="similarity-server" location="../infrastructure/services/similarity-server/src" />
  
  <property name="extractor-bin" location="../infrastructure/tools/java/extractor/bin" />
  <property name="machine-learning" location="../infrastructure/tools/core/machine-learning/src" />
	<property name="website" location="../website" />

  <target name="init">
    <mkdir dir="${build}" />
    <mkdir dir="${dist}" />
  </target>

  <!-- Link Crawler -->
  <target name="init-link-crawler" depends="init">
    <mkdir dir="${build-link-crawler}" />
  </target>
    
  <target name="compile-link-crawler" depends="init-link-crawler">
    <!-- Compile everything -->
    <javac destdir="${build-link-crawler}" debug="on" includeantruntime="false">
      <classpath>
        <pathelement path="${classpath}" />
        <fileset dir="${lib}">
          <include name="**/svnkit.jar" />
        </fileset>
      </classpath>
      <src path="${utilities}" />
      <src path="${database-utilities}" />
      <src path="${core-repository-manager}" />
      <src path="${link-crawler}" />
    </javac>

    <!-- Copy the source -->
    <copy todir="${build-link-crawler}">
      <fileset dir="${utilities}" includes="**/*.java" />
    </copy>
    <copy todir="${build-link-crawler}">
      <fileset dir="${database-utilities}" includes="**/*.java" />
    </copy>
    <copy todir="${build-link-crawler}">
      <fileset dir="${core-repository-manager}" includes="**/*.java" />
    </copy>
    <copy todir="${build-link-crawler}">
      <fileset dir="${link-crawler}" includes="**/*.java" />
    </copy>
    <unjar src="${lib}/mysql-connector-java-5.1.7-bin.jar" dest="${build-link-crawler}" />
    <unjar src="${lib}/svnkit.jar" dest="${build-link-crawler}" />
  </target>
  
  <target name="link-crawler" depends="compile-link-crawler" description="Build link crawler executable jar.">
    <jar destfile="${dist}/link-crawler.jar" basedir="${build-link-crawler}">
      <manifest>
        <attribute name="Main-Class" value="edu.uci.ics.sourcerer.tools.link.Main" />
      </manifest>
    </jar>
  </target>
  
  <!-- Java Repo Tools -->
  <target name="init-java-repo-tools" depends="init">
    <mkdir dir="${build-java-repo-tools}" />
  </target>
  
  <target name="compile-java-repo-tools" depends="init-java-repo-tools">
    <!-- Compile everything -->
    <javac destdir="${build-java-repo-tools}" debug="on" includeantruntime="false">
      <src path="${utilities}" />
      <src path="${core-repository-manager}" />
      <src path="${java-repository-manager}" />
      <classpath>
        <pathelement path="${classpath}" />
          <fileset dir="${lib}">
            <include name="**/guava-11.0.1.jar" />
          </fileset>
      </classpath>
    </javac>

    <!-- Copy the source -->
    <copy todir="${build-java-repo-tools}">
      <fileset dir="${utilities}" includes="**/*.java" />
    </copy>
    <copy todir="${build-java-repo-tools}">
      <fileset dir="${core-repository-manager}" includes="**/*.java" />
    </copy>
    <copy todir="${build-java-repo-tools}">
      <fileset dir="${java-repository-manager}" includes="**/*.java" />
    </copy>
    <unjar src="${lib}/guava-11.0.1.jar" dest="${build-java-repo-tools}" />
  </target>
  
  <target name="java-repo-tools" depends="compile-java-repo-tools" description="Build java repository tools executable jar. (repo-tools.jar)">
    <jar destfile="${dist}/repo-tools.jar" basedir="${build-java-repo-tools}">
      <manifest>
        <attribute name="Main-Class" value="edu.uci.ics.sourcerer.tools.java.repo.Main" />
      </manifest>
    </jar>
  </target>
  
  <!-- Database Tools -->
  <target name="init-database" depends="init">
    <mkdir dir="${build-database}" />
  </target>
  
  <target name="compile-database" depends="init-database">
    <!-- Compile everything -->
    <javac destdir="${build-database}" debug="on" includeantruntime="false">
      <src path="${utilities}" />
      <src path="${database-utilities}" />
      <src path="${core-repository-manager}" />
      <src path="${java-repository-manager}" />
      <src path="${model}" />
    	<src path="${utilization}" />
      <src path="${database}" />
    	<classpath>
        <pathelement path="${classpath}" />
          <fileset dir="${lib}">
          	<include name="**/asm-4.0_RC2.jar" />
            <include name="**/guava-11.0.1.jar" />
          </fileset>
      </classpath>
    </javac>

    <!-- Copy the source -->
    <copy todir="${build-database}">
      <fileset dir="${utilities}" includes="**/*.java" />
    </copy>
    <copy todir="${build-database}">
      <fileset dir="${database-utilities}" includes="**/*.java" />
    </copy>
    <copy todir="${build-database}">
      <fileset dir="${core-repository-manager}" includes="**/*.java" />
    </copy>
    <copy todir="${build-database}">
      <fileset dir="${java-repository-manager}" includes="**/*.java" />
    </copy>
    <copy todir="${build-database}">
      <fileset dir="${model}" includes="**/*.java" />
    </copy>
  	<copy todir="${build-database}">
      <fileset dir="${utilization}" includes="**/*.java" />
    </copy>
    <copy todir="${build-database}">
      <fileset dir="${database}" includes="**/*.java" />
    </copy>
    <unjar src="${lib}/mysql-connector-java-5.1.7-bin.jar" dest="${build-database}" />
  	<unjar src="${lib}/guava-11.0.1.jar" dest="${build-database}" />
  	<unjar src="${lib}/asm-4.0_RC2.jar" dest="${build-database}" />
  </target>
  
  <target name="sourcerer-db" depends="compile-database" description="Build database tools executable jar. (sourcerer-db.jar)">
    <jar destfile="${dist}/sourcerer-db.jar" basedir="${build-database}">
      <manifest>
        <attribute name="Main-Class" value="edu.uci.ics.sourcerer.tools.java.db.Main" />
      </manifest>
    </jar>
  </target>
  
  <!-- Utilization -->
  <target name="init-utilization" depends="init">
    <mkdir dir="${build-utilization}" />
  </target>
      
  <target name="compile-utilization" depends="init-utilization">
    <!-- Compile everything -->
    <javac destdir="${build-utilization}" debug="on" includeantruntime="false">
      <src path="${utilities}" />
      <src path="${core-repository-manager}" />
      <src path="${java-repository-manager}" />
      <src path="${model}" />
      <src path="${utilization}" />
    	<classpath>
        <pathelement path="${classpath}" />
	        <fileset dir="${lib}">
	        	<include name="**/guava-11.0.1.jar" />
	          <include name="**/asm-4.0_RC2.jar" />
	        </fileset>
      </classpath>
    </javac>

    <!-- Copy the source -->
    <copy todir="${build-utilization}">
      <fileset dir="${utilities}" includes="**/*.java" />
    </copy>
    <copy todir="${build-utilization}">
      <fileset dir="${core-repository-manager}" includes="**/*.java" />
    </copy>
    <copy todir="${build-utilization}">
      <fileset dir="${java-repository-manager}" includes="**/*.java" />
    </copy>
    <copy todir="${build-utilization}">
      <fileset dir="${model}" includes="**/*.java" />
    </copy>
    <copy todir="${build-utilization}">
      <fileset dir="${utilization}" includes="**/*.java" />
    </copy>
  	<unjar src="${lib}/guava-11.0.1.jar" dest="${build-utilization}" />
    <unjar src="${lib}/asm-4.0_RC2.jar" dest="${build-utilization}" />
  </target>
    
  <target name="utilization" depends="compile-utilization" description="Build utilization executable jar. (utilization.jar)">
    <jar destfile="${dist}/utilization.jar" basedir="${build-utilization}">
      <manifest>
        <attribute name="Main-Class" value="edu.uci.ics.sourcerer.tools.java.utilization.Main" />
      </manifest>
    </jar>
  </target>
  
  <!-- Artifact Repo Server -->
  <target name="init-artifact-repo-browser" depends="init">
    <mkdir dir="${build-artifact-repo-browser}" />
  </target>
        
  <target name="compile-artifact-repo-browser" depends="init-artifact-repo-browser">
    <!-- Compile everything -->
    <javac destdir="${build-artifact-repo-browser}" debug="on" includeantruntime="false">
      <src path="${utilities}" />
      <src path="${core-repository-manager}" />
      <src path="${java-repository-manager}" />
      <src path="${model}" />
      <src path="${utilization}" />
    	<src path="${database}" />
      <src path="${database-utilities}" />
      <src path="${artifact-repo-browser}" />
      <src path="${servlet-utilities}" />
      <classpath>
        <pathelement path="${classpath}" />
          <fileset dir="${lib}">
            <include name="**/guava-11.0.1.jar" />
            <include name="**/asm-4.0_RC2.jar" />
            <include name="**/servlet-api.jar" />
          </fileset>
      </classpath>
    </javac>
    <unjar src="${lib}/mysql-connector-java-5.1.7-bin.jar" dest="${build-artifact-repo-browser}" />
    <unjar src="${lib}/guava-11.0.1.jar" dest="${build-artifact-repo-browser}" />
    <unjar src="${lib}/asm-4.0_RC2.jar" dest="${build-artifact-repo-browser}" />
  </target>
  
  <target name="artifact-repo-browser" depends="compile-artifact-repo-browser" description="Build artifact repo server war. (artifact-repo-server.war)">
    <war destfile="${dist}/artifact-repo-browser.war" webxml="${artifact-repo-browser}/edu/uci/ics/sourcerer/apps/artifactbrowser/web.xml">
      <lib dir="${artifact-repo-browser}/edu/uci/ics/sourcerer/apps/artifactbrowser">
        <include name="*.properties" />
      </lib>
      <classes dir="${build-artifact-repo-browser}" />
    </war>
  </target>

  <!-- File Server -->
  <target name="init-file-server" depends="init">
    <mkdir dir="${build-file-server}" />
  </target>
       
  <target name="compile-file-server" depends="init-file-server">
    <!-- Compile everything -->
    <javac destdir="${build-file-server}" debug="on" includeantruntime="false">
      <src path="${utilities}" />
      <src path="${core-repository-manager}" />
      <src path="${java-repository-manager}" />
      <src path="${model}" />
      <src path="${utilization}" />
      <src path="${database}" />
      <src path="${database-utilities}" />
      <src path="${file-server}" />
      <src path="${servlet-utilities}" />
      <classpath>
        <pathelement path="${classpath}" />
        <fileset dir="${lib}">
          <include name="**/guava-11.0.1.jar" />
          <include name="**/asm-4.0_RC2.jar" />
          <include name="**/servlet-api.jar" />
        </fileset>
      </classpath>
    </javac>
    <unjar src="${lib}/mysql-connector-java-5.1.7-bin.jar" dest="${build-file-server}" />
    <unjar src="${lib}/guava-11.0.1.jar" dest="${build-file-server}" />
    <unjar src="${lib}/asm-4.0_RC2.jar" dest="${build-file-server}" />
  </target>
  
  <target name="file-server" depends="compile-file-server" description="Builds the file server.">
    <war destfile="${dist}/file-server.war" webxml="${file-server}/edu/uci/ics/sourcerer/services/file/web.xml">
      <lib dir="${file-server}/edu/uci/ics/sourcerer/services/file">
        <include name="*.properties" />
      </lib>
      <classes dir="${build-file-server}" />
    </war>
  </target>
  
  <!-- Code Browser -->
  <target name="init-code-browser" depends="init">
    <mkdir dir="${build-code-browser}" />
  </target>
       
  <target name="compile-code-browser" depends="init-code-browser">
    <!-- Compile everything -->
    <javac destdir="${build-code-browser}" debug="on" includeantruntime="false">
      <src path="${utilities}" />
      <src path="${core-repository-manager}" />
      <src path="${java-repository-manager}" />
      <src path="${model}" />
      <src path="${utilization}" />
      <src path="${database}" />
      <src path="${database-utilities}" />
      <src path="${code-browser}" />
      <src path="${syntax-highlighter}" />
      <src path="${servlet-utilities}" />
      <classpath>
        <pathelement path="${classpath}" />
        <fileset dir="${lib}">
          <include name="**/guava-11.0.1.jar" />
          <include name="**/asm-4.0_RC2.jar" />
          <include name="**/servlet-api.jar" />
        </fileset>
      </classpath>
    </javac>
    <unjar src="${lib}/mysql-connector-java-5.1.7-bin.jar" dest="${build-code-browser}" />
    <unjar src="${lib}/guava-11.0.1.jar" dest="${build-code-browser}" />
    <unjar src="${lib}/asm-4.0_RC2.jar" dest="${build-code-browser}" />
  </target>
  
  <target name="code-browser" depends="compile-code-browser" description="Builds the code browser.">
    <war destfile="${dist}/code-browser.war" webxml="${code-browser}/edu/uci/ics/sourcerer/apps/codebrowser/web.xml">
      <lib dir="${code-browser}/edu/uci/ics/sourcerer/apps/codebrowser">
        <include name="*.properties" />
      </lib>
      <classes dir="${build-code-browser}" />
    </war>
  </target>
  
  <!--
	<target name="famix-server" depends="compile-java-tools-core">
    <war destfile="${dist}/famix-server.war" webxml="${famix-server}/edu/uci/ics/sourcerer/server/famix/web.xml">
      <lib dir="${famix-server}/edu/uci/ics/sourcerer/server/famix">
        <include name="*.properties" />
      </lib>
      <classes dir="${build-java-tools-core}" />
    </war>
  </target>
	

	
	<target name="component-clusterer" depends="compile-java-tools-core">
		<jar destfile="${dist}/component-clusterer.jar" basedir="${build-java-tools-core}">
		  <manifest>
		  	 <attribute name ="Main-Class" value="edu.uci.ics.sourcerer.clusterer.Main" />
			</manifest>
		</jar>
	</target>
	
	  <target name="clean-java-tools">
    <delete dir="${build-java-tools-core}" />
    <delete>
      <fileset dir="${dist}">
        <include name="sourcerer-lib.jar" />
        <include name="repo-tools.jar" />
        <include name="sourcerer-db.jar" />
        <include name="file-server.war" />
        <include name="famix-server.war" />
      </fileset>
    </delete>
  </target>
-->
  <!-- Talk to sushil about how this works -->
  <target name="similarity-server" depends="compile-machine-learning">
    <war destfile="${dist}/similarity-server.war" webxml="${similarity-server}/edu/uci/ics/sourcerer/server/similarity/web.xml">
      <lib dir="${similarity-server}/edu/uci/ics/sourcerer/server/similarity">
      </lib>
      <lib dir="${lib}">
        <include name="**/mahout-core-*.jar" />
        <include name="**/slf4j-jdk14-1.5.5.jar" />
        <include name="**/slf4j-api-1.5.5.jar" />
        <include name="**/commons-*.jar" />
        <include name="**/uncommons-*.jar" />
        <include name="**/j2ee-*.jar" />
      </lib>
      <lib dir="${build-java-tools-core}">
        <include name="sourcerer-lib.jar" />
      </lib>
      <classes dir="${build-machine-learning}" />
    </war>
  </target>

  <!-- Populate the extractor's lib directory -->
  <target name="init-extractor-lib" depends="init">
    <mkdir dir="${build-extractor-lib}" />
  </target>
    
  <target name="compile-extractor-lib" depends="init-extractor-lib">
    <!-- Compile everything -->
    <javac destdir="${build-extractor-lib}" debug="on" includeantruntime="false">
      <src path="${utilities}" />
      <src path="${core-repository-manager}" />
      <src path="${java-repository-manager}" />
      <src path="${model}" />
      <src path="${utilization}" />
      <src path="${database}" />
      <src path="${database-utilities}" />
      <classpath>
        <pathelement path="${classpath}" />
          <fileset dir="${lib}">
            <include name="**/guava-11.0.1.jar" />
          	<include name="**/asm-4.0_RC2.jar" />
          </fileset>
      </classpath>
    </javac>

    <!-- Copy the source -->
    <copy todir="${build-extractor-lib}">
      <fileset dir="${utilities}" includes="**/*.java" />
    </copy>
    <copy todir="${build-extractor-lib}">
      <fileset dir="${core-repository-manager}" includes="**/*.java" />
    </copy>
    <copy todir="${build-extractor-lib}">
      <fileset dir="${java-repository-manager}" includes="**/*.java" />
    </copy>
    <copy todir="${build-extractor-lib}">
      <fileset dir="${model}" includes="**/*.java" />
    </copy>
  </target>
  
  <target name="extractor-lib" depends="compile-extractor-lib" description="Populate the Extractor's lib directory">
    <jar destfile="${extractor}/lib/sourcerer-lib.jar" basedir="${build-extractor-lib}" />
    <copy file="${lib}/asm-4.0_RC2.jar" todir="${extractor}/lib/" />
  	<copy file="${lib}/guava-11.0.1.jar" todir="${extractor}/lib/" />
    <copy file="${lib}/mysql-connector-java-5.1.7-bin.jar" todir="${extractor}/lib/" />
  </target>
  
  <!-- Build the extractor plugin - is asynchronous -->
  <target name="extractor" description="Build the extractor plugin.">
    <pde.exportPlugins destination="${build}" exportSource="true" exportType="directory" plugins="Extractor" useJARFormat="true" />
  </target>

  <!-- Repackage the plugin jar file - run after the extractor target -->
  <target name="repackage-extractor" depends="compile-extractor-lib">
    <unjar src="${build}/plugins/Extractor_1.0.0.jar" dest="${build-extractor}" />
    <copy todir="${build-extractor}">
      <fileset dir="${build-extractor-lib}" includes="**/*" />
    </copy>
    <zip destfile="${dist}/Extractor_1.0.0.jar" basedir="${build-extractor}" />
  </target>

  <target name="scs">
    <war destfile="${dist}/scs.war" webxml="../infrastructure/apps/codesearch/war/WEB-INF/web.xml" basedir="../infrastructure/apps/codesearch/war">
      <lib dir="${lib}">
        <include name="mysql*.jar" />
        <include name="smartgwt*.jar" />
        <include name="commons*.jar" />
        <include name="gwt*.jar" />
      </lib>
      <exclude name="**/.gitignore" />
      <exclude name="evaluation/results/**/*" />
    </war>
  </target>

  <target name="init-search-eval" depends="init">
    <mkdir dir="${build-search-eval}" />
  </target>

  <target name="compile-search-eval" depends="init-search-eval">
    <javac destdir="${build-search-eval}" debug="on" excludes="**/sourcerer/db/**/*.java,**/sourcerer/scs/**/*.java,**/sourcerer/eval/client/**/*.java,**/sourcerer/eval/server/**/*.java" includeantruntime="false">
      <src path="${utilities}" />
      <src path="${repository-manager}" />
      <src path="${model}" />
      <src path="${search-eval}" />
    </javac>
    <copy todir="${build-search-eval}">
      <fileset dir="${utilities}" includes="**/*.java" />
    </copy>
    <copy todir="${build-search-eval}">
      <fileset dir="${repository-manager}" includes="**/*.java" />
    </copy>
    <copy todir="${build-search-eval}">
      <fileset dir="${model}" includes="**/*.java" />
    </copy>
    <copy todir="${build-search-eval}">
      <fileset dir="${search-eval}" includes="**/*.java" />
    </copy>
  </target>

  <target name="search-eval" depends="compile-search-eval">
    <jar destfile="${dist}/search-eval.jar" basedir="${build-search-eval}">
      <manifest>
        <attribute name="Main-Class" value="edu.uci.ics.sourcerer.eval.CalculateTopStats" />
      </manifest>
    </jar>
  </target>

  <target name="clean-search-eval">
    <delete dir="${build-search-eval}" />
    <delete>
      <fileset dir="${dist}">
        <include name="search-eval.jar" />
      </fileset>
    </delete>
  </target>

  <target name="init-search-server" depends="init">
    <mkdir dir="${build-search-server}" />
  </target>

  <target name="compile-search-server" depends="init-search-server, sourcerer-db">
    <javac destdir="${build-search-server}" debug="on" includeantruntime="false">
      <classpath>
        <pathelement path="${classpath}" />
        <fileset dir="${lib}">
          <include name="**/apache-solr-core-1.4.0.jar" />
          <include name="**/apache-solr-solrj-1.4.0.jar" />
          <include name="**/apache-solr-dataimporthandler-1.4.0.jar" />
          <include name="**/lucene-core-2.9.1.jar" />
          <include name="**/lucene-snowball-2.9.1.jar" />
          <include name="**/commons-httpclient-*.jar" />
          <include name="**/commons-cli-*.jar" />
          <include name="**/servlet-api.jar" />
          <!-- ml dependencies -->
          <include name="**/mahout-core-0.3-SNAPSHOT.jar" />
          <include name="**/slf4j-api-1.5.5.jar" />
          <include name="**/slf4j-jdk14-1.5.5.jar" />
          <include name="**/commons-*.jar" />
          <include name="**/uncommons-*.jar" />
          <include name="**/mysql-*.jar" />
          <include name="**/j2ee-*.jar" />
        </fileset>
        <fileset dir=".">
          <include name="**/sourcerer-db.jar" />
        </fileset>
      </classpath>
      <src path="${search-server}" />
      <src path="${utilities}" />
      <src path="${machine-learning}" />

    </javac>
    <!--
		<copy todir="${build-search-server}">
			<fileset dir="${utilities}" includes="**/*.java" />
		</copy>
		<copy todir="${build-search-server}">
			<fileset dir="${search-server}" includes="**/*.java" />
		</copy>
		-->
  </target>

  <target name="search-server" depends="compile-search-server">
    <jar destfile="${dist}/sourcerer-search.jar" basedir="${build-search-server}" />
  </target>

  <target name="clean-search-server">
    <delete dir="${build-search-server}" />
    <delete>
      <fileset dir="${dist}">
        <include name="sourcerer-search.jar" />
      </fileset>
    </delete>
  </target>

  <target name="init-core-repomanager" depends="init">
    <mkdir dir="${build-core-repomanager}" />
  </target>

  <target name="compile-core-repomanager" depends="init-core-repomanager">
    <javac destdir="${build-core-repomanager}" debug="on" includeantruntime="false">
      <classpath>
        <pathelement path="${classpath}" />
        <fileset dir="${lib}">
          <include name="**/ant-*.jar" />
          <include name="**/commons-cli-*.jar" />
          <include name="**/guice-*.jar" />
          <include name="**/svnclientadapter-*.jar" />
        </fileset>
      </classpath>
      <src path="${core-repository-manager}" />
    </javac>
    <copy todir="${build-core-repomanager}">
      <fileset dir="${core-repository-manager}" includes="**/*.java" />
    </copy>
  </target>

  <target name="core-repomanager" depends="compile-core-repomanager">
    <jar destfile="${dist}/core-repomanager.jar" basedir="${build-core-repomanager}" />
    <copy file="${core-repository-manager}/../scripts/content-fetcher.sh" todir="${dist}" />
    <copy file="${core-repository-manager}/../scripts/repo-folder-creator.sh" todir="${dist}" />
  </target>

  <target name="clean-core-repomanager">
    <delete dir="${build-core-repomanager}" />
    <delete>
      <fileset dir="${dist}">
        <include name="core-repomanager.jar" />
        <include name="content-fetcher.sh" />
        <include name="repo-folder-creator.sh" />
      </fileset>
    </delete>
  </target>

  <target name="init-codecrawler" depends="init">
    <mkdir dir="${build-codecrawler}" />
  </target>

  <target name="compile-codecrawler" depends="init-codecrawler">
    <javac destdir="${build-codecrawler}" debug="on" source="1.5" includeantruntime="false">
      <classpath>
        <pathelement path="${classpath}" />
        <fileset dir="${lib}">
          <include name="**/htmlparser-*.jar" />
          <include name="**/log4j-*.jar" />
        </fileset>
      </classpath>
      <src path="${codecrawler}" />
    </javac>
    <copy todir="${build-codecrawler}">
      <fileset dir="${codecrawler}" includes="**/*.java" />
    </copy>
  </target>

  <target name="codecrawler" depends="compile-codecrawler">
    <jar destfile="${dist}/codecrawler.jar" basedir="${build-codecrawler}" />
    <copy file="${codecrawler}/../scripts/run-codecrawler.sh" todir="." />
  </target>

  <target name="clean-codecrawler">
    <delete dir="${build-codecrawler}" />
    <delete>
      <fileset dir="${dist}">
        <include name="codecrawler.jar" />
      </fileset>
    </delete>
  </target>

  <target name="fetch-patch-solr" depends="init">
    <get src="http://www.apache.org/dist/lucene/solr/1.3.0/apache-solr-1.3.0.tgz" dest="${build}/apache-solr-1.3.0.tgz" />
    <untar src="${build}/apache-solr-1.3.0.tgz" dest="${build}" compression="gzip" />
    <move todir="${solr-root}">
      <fileset dir="${build}/apache-solr-1.3.0">
        <include name="**/*" />
      </fileset>
    </move>
    <get src="http://issues.apache.org/jira/secure/attachment/12407410/SOLR-236_collapsing.patch" dest="${solr-root}/SOLR-236_collapsing.patch" />
    <patch patchfile="${solr-root}/SOLR-236_collapsing.patch" strip="0" dir="${solr-root}" />
    <move file="${solr-root}/src/common/org/apache/solr/common/params/CollapseParams.java" todir="${solr-root}/src/java/org/apache/solr/common/params" />
  </target>

  <!-- Construct the test repository -->
  <target name="create-test-repo" depends="compile-extractor-lib, java-repo-tools" description="Construct the test repository.">
    <!-- Clear 0/1 -->
    <delete dir="${test-repo}/0/1/content" />

    <!-- Setup 0/1 with the extractor -->
    <copy todir="${test-repo}/0/1/content">
      <fileset dir="${extractor}" includes="**/*.java" excludes="**/test-repo/**"/>
    </copy>
    <copy todir="${test-repo}/0/1/content">
      <fileset dir="${extractor}/lib" includes="sourcerer-lib.jar" />      
    </copy>

    <!-- Build the comparison test jar -->
    <mkdir dir="${build-comparison-test}" />
    <javac destdir="${build-comparison-test}" debug="on" includeantruntime="false">
      <src path="${comparison-test}" />
    </javac>
    
    <copy todir="${build-comparison-test}">
      <fileset dir="${comparison-test}" includes="**/*.java" />
    </copy>

    <jar destfile="${dist}/comparison-test.jar" basedir="${build-comparison-test}" />
    
    <copy todir="${test-repo}/0/2/content">
      <fileset dir="${dist}" includes="comparison-test.jar" />
    </copy>
        
    <!-- Clear the old output -->
    <delete dir="${test-repo}/output" />
    <delete dir="${test-repo}/jars" />
    
    <!-- Aggregate the jar repository -->
    <java jar="${dist}/repo-tools.jar" fork="true">
      <arg value="--aggregate-jar-files" />
      <arg value="--input-repo" />
      <arg value="${test-repo}" />
      <arg value="--output" />
      <arg value="${test-repo}/output" />
      <arg value="--clear-caches" />
    </java>
  </target>

  <target name="clean" description="clean up">
    <delete dir="${build}" />
    <delete dir="${dist}" />
  </target>

  <target name="init-machine-learning" depends="init">
    <mkdir dir="${build-machine-learning}" />
  </target>

  <target name="compile-machine-learning" depends="init-machine-learning, sourcerer-db">
    <javac destdir="${build-machine-learning}" debug="on" includeantruntime="false">
      <src path="${machine-learning}" />
      <src path="${similarity-server}" />
      <src path="${utilities}" />
      <!--
			<src path="${database}" />
			-->
      <classpath>
        <pathelement path="${classpath}" />
        <fileset dir="${lib}">
          <include name="**/mahout-core-*.jar" />
          <include name="**/slf4j-*.jar" />
          <include name="**/commons-*.jar" />
          <include name="**/mahout-core-*.jar" />
          <include name="**/uncommons-*.jar" />
          <include name="**/mysql-*.jar" />
          <include name="**/j2ee-*.jar" />
          <include name="**/servlet-api.jar" />

        </fileset>
        <fileset dir=".">
          <include name="**/sourcerer-db.jar" />
        </fileset>
      </classpath>
    </javac>
    <copy todir="${build-machine-learning}">
      <fileset dir="${machine-learning}" includes="**/*.java" />
    </copy>

    <!--
		<copy todir="${build-machine-learning}">
		      <fileset dir="${database}" includes="**/*.java" />
		 </copy>
		<copy todir="${build-machine-learning}">
		      <fileset dir="${utilities}" includes="**/*.java" />
		</copy>
		-->

  </target>

  <target name="machine-learning" depends="compile-machine-learning">
    <jar destfile="${dist}/sourcerer-ml.jar" basedir="${build-machine-learning}">
    </jar>
  </target>

  <target name="clean-machine-learning">
    <delete dir="${build-machine-learning}" />
    <delete>
      <fileset dir="${dist}">
        <include name="sourcerer-ml.jar" />
      </fileset>
    </delete>
  </target>

	<target name="package-website">
		<zip destfile="${dist}/website.zip" basedir="${website}" />
  </target>
</project>
